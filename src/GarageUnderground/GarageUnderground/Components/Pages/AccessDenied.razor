@page "/access-denied"
@rendermode InteractiveServer
@using GarageUnderground.Authentication.Client
@inject ApiAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Accesso Negato - GarageUnderground</PageTitle>

<div class="access-denied-container">
    @if (!initialized)
    {
        <div class="loading">
            <span class="loading-spinner"></span>
            <span>Caricamento...</span>
        </div>
    }
    else if (user?.IsAuthenticated != true)
    {
        <div class="not-authenticated">
            <h1>Non Autenticato</h1>
            <p>Devi effettuare l'accesso per visualizzare questa pagina.</p>
            <a href="/" class="btn-action">Vai alla Home</a>
        </div>
    }
    else if (hasAccess)
    {
        <div class="has-access">
            <h1>Hai gi&agrave; accesso!</h1>
            <p>Il tuo account &egrave; gi&agrave; abilitato.</p>
            <a href="/dashboard" class="btn-action">Vai alla Dashboard</a>
        </div>
    }
    else
    {
        <div class="denied-content">
            <div class="denied-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636"/>
                </svg>
            </div>
            <h1>Accesso Non Autorizzato</h1>
            <p class="denied-message">
                Non hai ancora il permesso di entrare nell'applicazione.<br />
                Chiedi ad un utente amministratore di abilitare il tuo account.
            </p>
            
            <div class="account-info">
                <span class="account-label">Il tuo Account ID:</span>
                <div class="account-id">
                    <code>@userEmail</code>
                    <button class="btn-copy" @onclick="CopyToClipboard" title="Copia negli appunti">
                        @if (copied)
                        {
                            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        }
                        else
                        {
                            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        }
                    </button>
                </div>
            </div>

            <p class="hint">
                Comunica questo identificativo all'amministratore per richiedere l'accesso.
            </p>

            <div class="actions">
                <button class="btn-logout" @onclick="Logout">Esci</button>
            </div>
        </div>
    }
</div>

@code {
    private UserInfo? user;
    private string? userEmail;
    private bool initialized;
    private bool hasAccess;
    private bool copied;

    protected override async Task OnInitializedAsync()
    {
        user = await AuthStateProvider.GetCurrentUserAsync(forceRefresh: true);
        
        if (user?.IsAuthenticated == true)
        {
            userEmail = user.Email;
            hasAccess = user.Roles?.Any(r => r.Equals("canLogin", StringComparison.OrdinalIgnoreCase)) == true;
        }
        
        initialized = true;
    }

    private async Task CopyToClipboard()
    {
        if (!string.IsNullOrEmpty(userEmail))
        {
            try
            {
                // Use JavaScript interop to copy to clipboard
                await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", userEmail);
                copied = true;
                StateHasChanged();
                
                await Task.Delay(2000);
                copied = false;
                StateHasChanged();
            }
            catch
            {
                // Ignore clipboard errors (e.g., if clipboard API is not available)
            }
        }
    }

    private async Task Logout()
    {
        await AuthStateProvider.LogoutAsync();
        Navigation.NavigateTo("/", forceLoad: true);
    }
}
